name: Build

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release'
        type: boolean
        default: true
      draft:
        description: 'Create as draft release'
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            label: Windows
            rust-target: ''
            args: ''
          - os: ubuntu-22.04
            label: Linux
            rust-target: ''
            args: ''
          - os: self-hosted
            label: macOS
            runner-labels: '["self-hosted", "macOS", "ARM64"]'
            rust-target: aarch64-apple-darwin
            args: '--target aarch64-apple-darwin --bundles app'

    name: Build (${{ matrix.label }})
    runs-on: ${{ matrix.runner-labels && fromJSON(matrix.runner-labels) || matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      # --- Windows + GitHub-hosted setup ---
      - name: Setup Node.js
        if: matrix.os != 'self-hosted'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        if: matrix.os != 'self-hosted'
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

      - name: Rust cache
        if: matrix.os != 'self-hosted'
        uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
        with:
          workspaces: src-tauri

      # --- Linux: Install system dependencies ---
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

      # --- macOS: Import Apple Developer Certificate ---
      - name: Import Apple Developer Certificate
        if: matrix.os == 'self-hosted' && runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          echo "$APPLE_CERTIFICATE" | base64 --decode > "$CERTIFICATE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERTIFICATE_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain

      # --- macOS: Add Rust target ---
      - name: Add Rust target (macOS)
        if: matrix.rust-target != ''
        run: rustup target add ${{ matrix.rust-target }}

      # --- Common steps ---
      - name: Install frontend dependencies
        run: npm ci

      - name: Build and release Tauri app
        uses: tauri-apps/tauri-action@79c624843491f12ae9d63592534ed49df3bc4adb # v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # TODO v1.0.0: re-enable notarization
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: v__VERSION__
          releaseName: SimplyTerm v__VERSION__
          releaseDraft: ${{ inputs.draft }}
          prerelease: false
          args: ${{ matrix.args }}

      # --- macOS: Cleanup keychain ---
      - name: Cleanup keychain
        if: always() && matrix.os == 'self-hosted' && runner.os == 'macOS'
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi
